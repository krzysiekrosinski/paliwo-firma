<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Paliwo – Firma</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{ box-sizing:border-box; }
html,body{ margin:0; padding:0; width:100%; overflow-x:hidden; }

:root{
  --bg0:#070a15;
  --bg1:#0b1020;
  --card:rgba(18,26,51,.78);
  --border:rgba(90,120,220,.25);
  --border2:rgba(120,160,255,.22);
  --text:#eaf0ff;
  --muted:#a9baf3;
  --brand:#4b7dff;
  --brand2:#2a3a6b;
  --ok:#8dffb0;
  --err:#ff4d4d;
  --shadow: 0 14px 40px rgba(0,0,0,.45);
  --radius:18px;
  --radius2:14px;
}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 600px at 20% 0%, rgba(75,125,255,.20), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(140,90,255,.14), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

.safe{
  padding-left: max(12px, env(safe-area-inset-left));
  padding-right:max(12px, env(safe-area-inset-right));
}

.wrap{ max-width:1100px; margin:0 auto; padding:14px 12px 40px; }

.header{
  display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;
}
.title{ display:flex; gap:10px; align-items:center; }
.logo{
  width:34px;height:34px;border-radius:12px;
  background:linear-gradient(135deg, rgba(75,125,255,.95), rgba(120,90,255,.75));
  box-shadow: 0 10px 26px rgba(75,125,255,.25);
  display:grid;place-items:center; font-weight:900;
}
h1{ font-size:26px; margin:0; letter-spacing:.2px; }
.sub{ margin:6px 0 0; font-size:13px; color:var(--muted); }

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  overflow:hidden;
  margin:12px 0;
}
.cardInner{ padding:14px; }
.cardTitle{ margin:0 0 10px; font-size:18px; letter-spacing:.2px; }
.hr{
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(120,160,255,.25), transparent);
  margin:12px 0;
}

.grid2{ display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap:10px; }
.grid3{ display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap:10px; }
.stack{ display:flex; flex-direction:column; gap:10px; }

label{ font-size:12.5px; color:var(--muted); margin:2px 0 -4px; }

.input{
  width:100%;
  min-width:0;
  padding:12px 12px;
  border-radius:var(--radius2);
  border:1px solid var(--border2);
  background:rgba(8,12,26,.70);
  color:var(--text);
  font-size:16px;
  outline:none;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
.input:focus{
  border-color: rgba(90,140,255,.55);
  box-shadow: 0 0 0 4px rgba(75,125,255,.15), inset 0 0 0 1px rgba(0,0,0,.08);
}

/* iOS date/time overflow fix */
input[type="date"].input,
input[type="time"].input{
  width:100% !important;
  max-width:100% !important;
  min-width:0 !important;
  -webkit-appearance:none;
  appearance:none;
  background-clip: padding-box;
}

.btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
.btn{
  width:100%;
  border:none;
  border-radius:16px;
  padding:13px 14px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  color:var(--text);
  background:linear-gradient(135deg, rgba(75,125,255,1), rgba(110,90,255,1));
  box-shadow: 0 10px 24px rgba(75,125,255,.25);
}
.btn:active{ transform: translateY(1px); }
.btn.secondary{
  background:rgba(42,58,107,.75);
  box-shadow:none;
  border:1px solid rgba(120,160,255,.20);
}
.btn.small{ width:auto; padding:9px 12px; border-radius:14px; font-size:14px; }

.msg{ margin-top:10px; font-size:14px; color:var(--muted); }
.msg .ok{ color:var(--ok); font-weight:700; }
.msg .err{ color:var(--err); font-weight:700; }

.userStrip{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
}
.pill{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius:999px;
  background:rgba(8,12,26,.55);
  border:1px solid rgba(120,160,255,.18);
  color:var(--muted); font-size:13px;
}
.pill b{ color:var(--text); }

.fileBox{
  border:1px dashed rgba(120,160,255,.30);
  background:rgba(8,12,26,.50);
  border-radius:16px;
  padding:12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.fileBox .name{
  color:var(--muted);
  font-size:13px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.fileBtn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(120,160,255,.22);
  background:rgba(42,58,107,.55);
  color:var(--text);
  font-weight:700;
  cursor:pointer;
  user-select:none;
  flex:0 0 auto;
}
.fileInput{ position:absolute; left:-9999px; width:1px; height:1px; }

.tableWrap{
  overflow-x:auto;
  border-radius:16px;
  border:1px solid rgba(120,160,255,.18);
  background:rgba(8,12,26,.45);
}
table{ width:100%; border-collapse:collapse; font-size:14px; }
th,td{
  padding:12px 10px;
  border-bottom:1px solid rgba(120,160,255,.12);
  text-align:left;
  white-space:nowrap;
}
th{
  color:var(--muted);
  font-weight:700;
  font-size:12.5px;
  letter-spacing:.3px;
  text-transform:uppercase;
}
tr:last-child td{ border-bottom:none; }

.tabs{
  display:flex; gap:8px; flex-wrap:wrap;
}
.tab{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(120,160,255,.18);
  background:rgba(8,12,26,.45);
  color:var(--muted);
  cursor:pointer;
  font-weight:700;
  font-size:13px;
}
.tab.active{
  background:rgba(75,125,255,.20);
  border-color: rgba(75,125,255,.35);
  color:var(--text);
}

a.link{
  color: #bcd0ff;
  text-decoration:none;
  font-weight:800;
}
a.link:active{ opacity:.8; }

.hide{ display:none; }

@media(max-width:900px){
  .grid3{ grid-template-columns:1fr; }
  .grid2{ grid-template-columns:1fr; }
  h1{ font-size:24px; }
  .wrap{ padding:14px 12px 34px; }
  .cardInner{ padding:13px; }
  .btnRow{ flex-direction:column; }
}
</style>
</head>

<body>
<div class="safe">
  <div class="wrap">

    <div class="header">
      <div class="title">
        <div class="logo">⛽</div>
        <div>
          <h1>Rejestr tankowań</h1>
          <div class="sub">Kierowca widzi tylko swój pojazd. Admin widzi wszystko.</div>
        </div>
      </div>
    </div>

    <!-- KONFIG -->
    <div class="card" id="cfgCard">
      <div class="cardInner">
        <div class="cardTitle">Konfiguracja połączenia</div>

        <div class="grid2">
          <div class="stack">
            <label>Supabase URL</label>
            <input id="sbUrl" class="input" placeholder="https://xxxxx.supabase.co">
          </div>
          <div class="stack">
            <label>Publishable key</label>
            <input id="sbKey" class="input" placeholder="sb_publishable_...">
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn" onclick="saveCfg()">Zapisz konfigurację</button>
        </div>
        <div class="msg">Po zapisaniu strona odświeży się automatycznie.</div>
      </div>
    </div>

    <!-- LOGOWANIE -->
    <div class="card hide" id="authCard">
      <div class="cardInner">
        <div class="cardTitle">Logowanie</div>

        <div class="grid2">
          <div class="stack">
            <label>Email</label>
            <input id="email" class="input" placeholder="kierowca@firma.pl" autocomplete="username">
          </div>
          <div class="stack">
            <label>Hasło</label>
            <input id="pass" class="input" type="password" placeholder="••••••••" autocomplete="current-password">
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn" onclick="login()">Zaloguj</button>
          <button class="btn secondary" onclick="logout()">Wyloguj</button>
        </div>

        <div id="authMsg" class="msg"></div>
      </div>
    </div>

    <!-- USER STRIP -->
    <div class="card hide" id="appCard">
      <div class="cardInner">
        <div class="userStrip">
          <div class="pill">Zalogowany: <b id="whoName">—</b> <span id="whoRole" style="opacity:.75"></span></div>
          <button class="btn secondary small" onclick="logout()">Wyloguj</button>
        </div>
      </div>
    </div>

    <!-- DRIVER PANEL -->
    <div class="card hide" id="driverFuelCard">
      <div class="cardInner">
        <div class="cardTitle">Dodaj tankowanie</div>

        <div class="grid2">
          <div class="stack">
            <label>Data</label>
            <input id="occurredDate" class="input" type="date">
          </div>
          <div class="stack">
            <label>Godzina</label>
            <input id="occurredTime" class="input" type="time">
          </div>
        </div>

        <div class="hr"></div>

        <div class="stack">
          <div class="stack">
            <label>Stan licznika (km)</label>
            <input id="odo" class="input" type="number" inputmode="numeric" placeholder="np. 200650">
          </div>

          <div class="grid2">
            <div class="stack">
              <label>Litry</label>
              <input id="liters" class="input" type="number" step="0.01" inputmode="decimal" placeholder="np. 65">
            </div>
            <div class="stack">
              <label>Cena za litr</label>
              <input id="ppl" class="input" type="number" step="0.01" inputmode="decimal" placeholder="np. 6.79">
            </div>
          </div>

          <div class="hr"></div>

          <div class="stack">
            <label>Zdjęcie licznika</label>
            <div class="fileBox">
              <div class="name" id="odoFileName">Nie wybrano pliku</div>
              <label class="fileBtn" for="photoOdo">Dodaj</label>
              <input id="photoOdo" class="fileInput" type="file" accept="image/*" capture="environment">
            </div>

            <label>Zdjęcie WZ</label>
            <div class="fileBox">
              <div class="name" id="recFileName">Nie wybrano pliku</div>
              <label class="fileBtn" for="photoRec">Dodaj</label>
              <input id="photoRec" class="fileInput" type="file" accept="image/*" capture="environment">
            </div>
          </div>

          <div class="hr"></div>

          <button class="btn" onclick="addFuel()">Zapisz tankowanie</button>
          <div id="fuelMsg" class="msg"></div>
        </div>
      </div>
    </div>

    <div class="card hide" id="driverHistCard">
      <div class="cardInner">
        <div class="cardTitle">Tankowania (ostatnie 50)</div>
        <div id="histMsg" class="msg"></div>

        <div class="tableWrap">
          <table id="histTbl" class="hide">
            <thead>
              <tr>
                <th>Data</th>
                <th>Licznik</th>
                <th>Litry</th>
                <th>l/100</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div class="card hide" id="adminCard">
      <div class="cardInner">
        <div class="cardTitle">Panel administratora</div>

        <div class="tabs" style="margin-bottom:10px">
          <div class="tab active" id="tabFuel" onclick="switchAdminTab('fuel')">Tankowania</div>
          <div class="tab" id="tabVehicles" onclick="switchAdminTab('vehicles')">Pojazdy</div>
          <div class="tab" id="tabAssign" onclick="switchAdminTab('assign')">Przypisania</div>
          <div class="tab" id="tabService" onclick="switchAdminTab('service')">Serwis</div>
        </div>

        <!-- ADMIN: TANKOWANIA -->
        <div id="adminFuel">
          <div class="grid2">
            <div class="stack">
              <label>Filtr: pojazd</label>
              <select id="adminVehicleFilter" class="input" onchange="adminLoadFuel()"></select>
            </div>
            <div class="stack">
              <label>Limit</label>
              <select id="adminFuelLimit" class="input" onchange="adminLoadFuel()">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div id="adminFuelMsg" class="msg"></div>
          <div class="tableWrap">
            <table id="adminFuelTbl" class="hide">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Pojazd</th>
                  <th>Kierowca</th>
                  <th>Licznik</th>
                  <th>Litry</th>
                  <th>l/100</th>
                  <th>Zdjęcia</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN: POJAZDY -->
        <div id="adminVehicles" class="hide">
          <div class="grid3">
            <div class="stack">
              <label>Rejestracja (unikalna)</label>
              <input id="vehPlate" class="input" placeholder="POJAZD-3">
            </div>
            <div class="stack">
              <label>Rodzaj paliwa</label>
              <select id="vehFuel" class="input">
                <option value="diesel" selected>diesel</option>
                <option value="petrol">benzyna</option>
              </select>
            </div>
            <div class="stack" style="align-self:end">
              <button class="btn" onclick="adminAddVehicle()">Dodaj pojazd</button>
            </div>
          </div>

          <div id="adminVehMsg" class="msg"></div>
          <div class="hr"></div>

          <div class="tableWrap">
            <table id="adminVehTbl" class="hide">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Rejestracja</th>
                  <th>Paliwo</th>
                  <th>Akcje</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN: PRZYPISANIA -->
        <div id="adminAssign" class="hide">
          <div class="grid3">
            <div class="stack">
              <label>Kierowca</label>
              <select id="assignDriver" class="input"></select>
            </div>
            <div class="stack">
              <label>Pojazd</label>
              <select id="assignVehicle" class="input"></select>
            </div>
            <div class="stack" style="align-self:end">
              <button class="btn" onclick="adminAssign()">Zapisz przypisanie</button>
            </div>
          </div>

          <div id="adminAssignMsg" class="msg"></div>
          <div class="hr"></div>

          <div class="tableWrap">
            <table id="adminAssignTbl" class="hide">
              <thead>
                <tr>
                  <th>Kierowca</th>
                  <th>Pojazd</th>
                  <th>Od</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN: SERWIS -->
        <div id="adminService" class="hide">
          <div class="grid3">
            <div class="stack">
              <label>Pojazd</label>
              <select id="serviceVehicle" class="input"></select>
            </div>
            <div class="stack">
              <label>Data</label>
              <input id="serviceDate" class="input" type="date">
            </div>
            <div class="stack">
              <label>Stan licznika (km)</label>
              <input id="serviceOdo" class="input" type="number" inputmode="numeric" placeholder="np. 201200">
            </div>
          </div>

          <div class="hr"></div>

          <div class="stack">
            <label>Opis</label>
            <input id="serviceDesc" class="input" placeholder="np. wymiana oleju + filtry">
            <label>Koszt (opcjonalnie)</label>
            <input id="serviceCost" class="input" type="number" step="0.01" inputmode="decimal" placeholder="np. 850.00">
          </div>

          <div class="hr"></div>

          <button class="btn" onclick="adminAddService()">Dodaj serwis</button>
          <div id="adminServiceMsg" class="msg"></div>

          <div class="hr"></div>

          <div id="adminServiceListMsg" class="msg"></div>
          <div class="tableWrap">
            <table id="adminServiceTbl" class="hide">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Pojazd</th>
                  <th>Licznik</th>
                  <th>Opis</th>
                  <th>Koszt</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
let sb=null, myProfile=null, myVehicleId=null;

const VEHICLE_1='33474aad-2d3c-4777-80f7-62eb16ce4434';
const VEHICLE_2='4b8b8534-3f12-41e1-af1a-24fb4f710cb3';

function pad(n){ return String(n).padStart(2,'0'); }

function setDefaultDateTime(){
  const d=new Date();
  occurredDate.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  occurredTime.value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function buildOccurredISO(){
  const date = occurredDate.value;
  const time = occurredTime.value || '00:00';
  if(!date) return new Date().toISOString();
  const dt = new Date(`${date}T${time}:00`);
  return dt.toISOString();
}

function saveCfg(){
  localStorage.setItem('SB_URL',sbUrl.value.trim());
  localStorage.setItem('SB_KEY',sbKey.value.trim());
  location.reload();
}

function loadCfg(){
  const url=localStorage.getItem('SB_URL')||'';
  const key=localStorage.getItem('SB_KEY')||'';
  sbUrl.value=url; sbKey.value=key;
  return{url,key};
}

function show(id,on=true){
  document.getElementById(id).classList.toggle('hide',!on);
}

function setFileName(inputEl, labelEl){
  const f = inputEl.files && inputEl.files[0];
  labelEl.textContent = f ? f.name : 'Nie wybrano pliku';
}

/* =========================
   INIT / AUTH
   ========================= */
async function init(){
  const{url,key}=loadCfg();
  if(!url||!key) return;

  show('cfgCard',false);
  show('authCard',true);

  sb = window.supabase.createClient(url,key);

  // file name listeners (driver)
  if(window.photoOdo){
    photoOdo.addEventListener('change', ()=>setFileName(photoOdo, odoFileName));
    photoRec.addEventListener('change', ()=>setFileName(photoRec, recFileName));
  }

  const { data: { session } } = await sb.auth.getSession();
  if(session) afterLogin();
}

async function login(){
  authMsg.innerHTML = 'Logowanie...';
  const { error } = await sb.auth.signInWithPassword({ email: email.value.trim(), password: pass.value });
  if(error){
    authMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }
  afterLogin();
}

async function logout(){
  if(sb) await sb.auth.signOut();
  show('appCard',false);
  show('driverFuelCard',false);
  show('driverHistCard',false);
  show('adminCard',false);
  show('authCard',true);
  authMsg.textContent='';
}

async function afterLogin(){
  const { data: { user } } = await sb.auth.getUser();

  const { data: prof, error: perr } = await sb
    .from('profiles')
    .select('id, full_name, role')
    .eq('id', user.id)
    .single();

  if(perr){
    authMsg.innerHTML = `<span class="err">Brak profilu w tabeli profiles dla tego konta.</span>`;
    return;
  }

  myProfile = prof;
  const { data: vId } = await sb.rpc('my_vehicle_id');
  myVehicleId = vId || null;

  show('authCard',false);
  show('appCard',true);

  whoName.textContent = myProfile.full_name || '—';
  whoRole.textContent = myProfile.role ? `(${myProfile.role})` : '';

  const isAdmin = myProfile.role === 'admin';

  show('driverFuelCard', !isAdmin);
  show('driverHistCard', !isAdmin);
  show('adminCard', isAdmin);

  if(!isAdmin){
    setDefaultDateTime();
    await loadDriverHistory();
  } else {
    await adminBootstrap();
  }
}

/* =========================
   DRIVER: add fuel + history
   ========================= */
async function addFuel(){
  fuelMsg.innerHTML = 'Zapisywanie...';

  const occurred = buildOccurredISO();
  const newOdo = parseInt(odo.value||'0',10);
  const l = parseFloat(liters.value||'0');
  const price = parseFloat(ppl.value||'0');

  if(!newOdo || l<=0){
    fuelMsg.innerHTML = `<span class="err">Uzupełnij licznik i litry.</span>`;
    return;
  }

  // prevent rollback odometer
  const { data: lastEntry } = await sb.from('fuel_entries')
    .select('odometer_km')
    .eq('vehicle_id', myVehicleId)
    .order('occurred_at', { ascending:false })
    .limit(1);

  if(lastEntry && lastEntry.length>0){
    const lastOdo = lastEntry[0].odometer_km;
    if(newOdo < lastOdo){
      fuelMsg.innerHTML = `<span class="err">Nie można cofnąć licznika. Ostatni stan: ${lastOdo} km</span>`;
      return;
    }
  }

  const { data, error } = await sb.from('fuel_entries')
    .insert({
      vehicle_id: myVehicleId,
      driver_id: myProfile.id,
      occurred_at: occurred,
      odometer_km: newOdo,
      liters: l,
      price_per_l: price
    })
    .select('id')
    .single();

  if(error){
    fuelMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  const fuelId = data.id;

  // upload photos
  const odoFile = photoOdo.files[0] || null;
  const recFile = photoRec.files[0] || null;

  try{
    if(odoFile){
      const up1 = await sb.storage.from('fuel-photos')
        .upload(`${myVehicleId}/odometer/${fuelId}.jpg`, odoFile, { upsert:false });
      if(up1.error) throw up1.error;
    }
    if(recFile){
      const up2 = await sb.storage.from('fuel-photos')
        .upload(`${myVehicleId}/receipt/${fuelId}.jpg`, recFile, { upsert:false });
      if(up2.error) throw up2.error;
    }
  }catch(e){
    fuelMsg.innerHTML = `<span class="err">Tankowanie zapisane, ale nie udało się wysłać zdjęcia: ${e.message}</span>`;
    await loadDriverHistory();
    return;
  }

  fuelMsg.innerHTML = `<span class="ok">Zapisano tankowanie</span>`;

  odo.value='';
  liters.value='';
  ppl.value='';
  photoOdo.value='';
  photoRec.value='';
  odoFileName.textContent='Nie wybrano pliku';
  recFileName.textContent='Nie wybrano pliku';
  setDefaultDateTime();

  await loadDriverHistory();
}

async function loadDriverHistory(){
  histMsg.textContent = 'Ładowanie...';

  const { data, error } = await sb.from('fuel_entries')
    .select('vehicle_id, occurred_at, odometer_km, liters')
    .order('occurred_at', { ascending:false })
    .limit(50);

  if(error){
    histMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  histMsg.textContent='';
  histTbl.classList.remove('hide');
  const tbody = histTbl.querySelector('tbody');
  tbody.innerHTML='';

  for(let i=0;i<data.length;i++){
    const r=data[i];
    const prev=data[i+1];

    let l100=null;
    if(prev){
      const km = r.odometer_km - prev.odometer_km;
      if(km>0) l100 = (Number(r.liters) / km) * 100;
    }

    let threshold=null;
    if(r.vehicle_id===VEHICLE_1) threshold=7.5;
    if(r.vehicle_id===VEHICLE_2) threshold=9.0;

    let l100Html='—';
    if(l100!=null){
      const val = l100.toFixed(2);
      if(threshold!=null && l100>threshold){
        l100Html = `<span style="color:#ff4d4d;font-weight:800">${val}</span>`;
      }else{
        l100Html = `<span style="font-weight:800">${val}</span>`;
      }
    }

    const dateOnly = new Date(r.occurred_at).toLocaleDateString('pl-PL');

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${dateOnly}</td>
        <td>${r.odometer_km ?? ''}</td>
        <td>${r.liters ?? ''}</td>
        <td>${l100Html}</td>
      </tr>
    `);
  }
}

/* =========================
   ADMIN PANEL
   ========================= */
function switchAdminTab(tab){
  // tabs
  const map = {fuel:['tabFuel','adminFuel'], vehicles:['tabVehicles','adminVehicles'], assign:['tabAssign','adminAssign'], service:['tabService','adminService']};
  for(const k of Object.keys(map)){
    document.getElementById(map[k][0]).classList.toggle('active', k===tab);
    show(map[k][1], k===tab);
  }
  // load on demand
  if(tab==='fuel') adminLoadFuel();
  if(tab==='vehicles') adminLoadVehicles();
  if(tab==='assign') adminLoadAssignments();
  if(tab==='service') adminLoadServices();
}

async function adminBootstrap(){
  // preload vehicle list + drivers list
  await adminRefreshDropdowns();
  // default tab
  switchAdminTab('fuel');
}

async function adminRefreshDropdowns(){
  // vehicles
  const { data: vehicles, error: verr } = await sb
    .from('vehicles')
    .select('id, plate, fuel_type')
    .order('plate', { ascending:true });

  if(verr){
    adminFuelMsg.innerHTML = `<span class="err">Błąd wczytania pojazdów: ${verr.message}</span>`;
    return;
  }

  // driver profiles
  const { data: drivers, error: derr } = await sb
    .from('profiles')
    .select('id, full_name, role')
    .order('full_name', { ascending:true });

  if(derr){
    adminFuelMsg.innerHTML = `<span class="err">Błąd wczytania profili: ${derr.message}</span>`;
    return;
  }

  // admin vehicle filter
  adminVehicleFilter.innerHTML = `<option value="">Wszystkie</option>` + vehicles.map(v=>`<option value="${v.id}">${v.plate}</option>`).join('');
  // assign dropdowns
  assignVehicle.innerHTML = vehicles.map(v=>`<option value="${v.id}">${v.plate}</option>`).join('');
  serviceVehicle.innerHTML = vehicles.map(v=>`<option value="${v.id}">${v.plate}</option>`).join('');

  const driverOnly = drivers.filter(p=>p.role==='driver');
  assignDriver.innerHTML = driverOnly.map(d=>`<option value="${d.id}">${d.full_name}</option>`).join('');
}

async function adminLoadFuel(){
  adminFuelMsg.textContent = 'Ładowanie...';
  adminFuelTbl.classList.add('hide');
  const tbody = adminFuelTbl.querySelector('tbody');
  tbody.innerHTML = '';

  const limit = parseInt(adminFuelLimit.value || '100', 10);
  const vehicleFilter = adminVehicleFilter.value || '';

  let q = sb
    .from('fuel_entries')
    .select('id, vehicle_id, driver_id, occurred_at, odometer_km, liters')
    .order('occurred_at', { ascending:false })
    .limit(limit);

  if(vehicleFilter) q = q.eq('vehicle_id', vehicleFilter);

  const { data, error } = await q;

  if(error){
    adminFuelMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  // bring vehicle plates + driver names in 2 quick maps
  const vehicleIds = [...new Set((data||[]).map(r=>r.vehicle_id))];
  const driverIds  = [...new Set((data||[]).map(r=>r.driver_id))];

  const { data: vehs } = await sb.from('vehicles').select('id, plate').in('id', vehicleIds.length?vehicleIds:['00000000-0000-0000-0000-000000000000']);
  const { data: prof } = await sb.from('profiles').select('id, full_name').in('id', driverIds.length?driverIds:['00000000-0000-0000-0000-000000000000']);

  const vehMap = Object.fromEntries((vehs||[]).map(v=>[v.id, v.plate]));
  const drvMap = Object.fromEntries((prof||[]).map(p=>[p.id, p.full_name]));

  adminFuelMsg.textContent = '';
  adminFuelTbl.classList.remove('hide');

  // l/100 computed per row using next (older) entry for same vehicle
  // We'll pre-group by vehicle
  const byVeh = {};
  for(const r of data){ (byVeh[r.vehicle_id] ||= []).push(r); }

  // For each vehicle list is already DESC by occurred_at, so l/100 for row i uses row i+1
  const l100Map = {};
  for(const vid of Object.keys(byVeh)){
    const rows = byVeh[vid];
    for(let i=0;i<rows.length;i++){
      const r = rows[i];
      const prev = rows[i+1];
      if(prev){
        const km = r.odometer_km - prev.odometer_km;
        if(km>0) l100Map[r.id] = (Number(r.liters)/km)*100;
      }
    }
  }

  for(const r of (data||[])){
    const dateOnly = new Date(r.occurred_at).toLocaleDateString('pl-PL');
    const plate = vehMap[r.vehicle_id] || r.vehicle_id?.slice(0,8);
    const driver = drvMap[r.driver_id] || r.driver_id?.slice(0,8);

    // thresholds
    let threshold = null;
    if(r.vehicle_id===VEHICLE_1) threshold=7.5;
    if(r.vehicle_id===VEHICLE_2) threshold=9.0;

    const l100 = l100Map[r.id];
    let l100Html = '—';
    if(l100!=null){
      const val = l100.toFixed(2);
      if(threshold!=null && l100>threshold){
        l100Html = `<span style="color:#ff4d4d;font-weight:800">${val}</span>`;
      }else{
        l100Html = `<span style="font-weight:800">${val}</span>`;
      }
    }

    // photo links (signed url by convention)
    const btnOdo = `<a class="link" href="#" onclick="openPhoto('${r.vehicle_id}','odometer','${r.id}');return false;">Licznik</a>`;
    const btnWz  = `<a class="link" href="#" onclick="openPhoto('${r.vehicle_id}','receipt','${r.id}');return false;">WZ</a>`;

    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${dateOnly}</td>
        <td>${plate}</td>
        <td>${driver}</td>
        <td>${r.odometer_km ?? ''}</td>
        <td>${r.liters ?? ''}</td>
        <td>${l100Html}</td>
        <td style="display:flex; gap:10px">${btnOdo} ${btnWz}</td>
      </tr>
    `);
  }
}

async function openPhoto(vehicleId, kind, fuelId){
  // kind: 'odometer' or 'receipt'
  const path = `${vehicleId}/${kind}/${fuelId}.jpg`;
  const { data, error } = await sb.storage.from('fuel-photos').createSignedUrl(path, 60);
  if(error){
    alert('Brak zdjęcia lub brak uprawnień.');
    return;
  }
  window.open(data.signedUrl, '_blank', 'noopener,noreferrer');
}

async function adminAddVehicle(){
  adminVehMsg.textContent = 'Zapisywanie...';
  const plate = (vehPlate.value||'').trim();
  const fuel = vehFuel.value;

  if(!plate){
    adminVehMsg.innerHTML = `<span class="err">Podaj rejestrację.</span>`;
    return;
  }

  const { error } = await sb.from('vehicles').insert({ plate, fuel_type: fuel });

  if(error){
    adminVehMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  adminVehMsg.innerHTML = `<span class="ok">Dodano pojazd</span>`;
  vehPlate.value='';
  await adminRefreshDropdowns();
  await adminLoadVehicles();
}

async function adminLoadVehicles(){
  adminVehMsg.textContent = 'Ładowanie...';
  adminVehTbl.classList.add('hide');
  const tbody = adminVehTbl.querySelector('tbody');
  tbody.innerHTML='';

  const { data, error } = await sb.from('vehicles').select('id, plate, fuel_type').order('plate',{ascending:true});
  if(error){
    adminVehMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  adminVehMsg.textContent='';
  adminVehTbl.classList.remove('hide');

  for(const v of (data||[])){
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${v.id.slice(0,8)}…</td>
        <td><b>${v.plate}</b></td>
        <td>${v.fuel_type}</td>
        <td>
          <button class="btn secondary small" onclick="adminDeleteVehicle('${v.id}','${v.plate.replaceAll("'","")}')">Usuń</button>
        </td>
      </tr>
    `);
  }
}

async function adminDeleteVehicle(id, plate){
  if(!confirm(`Usunąć pojazd ${plate}?`)) return;
  const { error } = await sb.from('vehicles').delete().eq('id', id);
  if(error){
    adminVehMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }
  adminVehMsg.innerHTML = `<span class="ok">Usunięto pojazd</span>`;
  await adminRefreshDropdowns();
  await adminLoadVehicles();
}

async function adminAssign(){
  adminAssignMsg.textContent = 'Zapisywanie...';
  const driver_id = assignDriver.value;
  const vehicle_id = assignVehicle.value;

  if(!driver_id || !vehicle_id){
    adminAssignMsg.innerHTML = `<span class="err">Wybierz kierowcę i pojazd.</span>`;
    return;
  }

  // upsert: jeśli masz unikalność driver_id lub vehicle_id, może wymagać innej logiki.
  // Tu robimy: usuń stare przypisania kierowcy i wstaw nowe.
  // (najprościej przy "na stałe")
  const del = await sb.from('vehicle_assignments').delete().eq('driver_id', driver_id);
  if(del.error){
    adminAssignMsg.innerHTML = `<span class="err">${del.error.message}</span>`;
    return;
  }

  const { error } = await sb.from('vehicle_assignments').insert({
    driver_id,
    vehicle_id,
    start_date: new Date().toISOString()
  });

  if(error){
    adminAssignMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  adminAssignMsg.innerHTML = `<span class="ok">Zapisano przypisanie</span>`;
  // refresh driver app logic uses RPC, so OK
  await adminLoadAssignments();
}

async function adminLoadAssignments(){
  adminAssignMsg.textContent = 'Ładowanie...';
  adminAssignTbl.classList.add('hide');
  const tbody = adminAssignTbl.querySelector('tbody');
  tbody.innerHTML='';

  const { data, error } = await sb.from('vehicle_assignments')
    .select('driver_id, vehicle_id, start_date')
    .order('start_date', { ascending:false });

  if(error){
    adminAssignMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  // maps
  const driverIds = [...new Set((data||[]).map(r=>r.driver_id))];
  const vehicleIds = [...new Set((data||[]).map(r=>r.vehicle_id))];

  const { data: prof } = await sb.from('profiles').select('id, full_name').in('id', driverIds.length?driverIds:['00000000-0000-0000-0000-000000000000']);
  const { data: vehs } = await sb.from('vehicles').select('id, plate').in('id', vehicleIds.length?vehicleIds:['00000000-0000-0000-0000-000000000000']);

  const drvMap = Object.fromEntries((prof||[]).map(p=>[p.id, p.full_name]));
  const vehMap = Object.fromEntries((vehs||[]).map(v=>[v.id, v.plate]));

  adminAssignMsg.textContent='';
  adminAssignTbl.classList.remove('hide');

  for(const r of (data||[])){
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${drvMap[r.driver_id] || r.driver_id.slice(0,8)+'…'}</td>
        <td><b>${vehMap[r.vehicle_id] || r.vehicle_id.slice(0,8)+'…'}</b></td>
        <td>${new Date(r.start_date).toLocaleDateString('pl-PL')}</td>
      </tr>
    `);
  }
}

async function adminAddService(){
  adminServiceMsg.textContent = 'Zapisywanie...';

  const vehicle_id = serviceVehicle.value;
  const date = serviceDate.value;
  const odoVal = parseInt(serviceOdo.value||'0',10);
  const desc = serviceDesc.value.trim();
  const cost = serviceCost.value ? parseFloat(serviceCost.value) : null;

  if(!vehicle_id || !date || !odoVal || !desc){
    adminServiceMsg.innerHTML = `<span class="err">Uzupełnij pojazd, datę, licznik i opis.</span>`;
    return;
  }

  const { error } = await sb.from('vehicle_services').insert({
    vehicle_id,
    service_date: date,
    odometer_km: odoVal,
    description: desc,
    cost
  });

  if(error){
    adminServiceMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  adminServiceMsg.innerHTML = `<span class="ok">Dodano serwis</span>`;
  serviceDate.value='';
  serviceOdo.value='';
  serviceDesc.value='';
  serviceCost.value='';

  await adminLoadServices();
}

async function adminLoadServices(){
  adminServiceListMsg.textContent = 'Ładowanie...';
  adminServiceTbl.classList.add('hide');
  const tbody = adminServiceTbl.querySelector('tbody');
  tbody.innerHTML='';

  const { data, error } = await sb.from('vehicle_services')
    .select('vehicle_id, service_date, odometer_km, description, cost')
    .order('service_date', { ascending:false })
    .limit(200);

  if(error){
    adminServiceListMsg.innerHTML = `<span class="err">${error.message}</span>`;
    return;
  }

  // vehicle map
  const vehicleIds = [...new Set((data||[]).map(r=>r.vehicle_id))];
  const { data: vehs } = await sb.from('vehicles').select('id, plate').in('id', vehicleIds.length?vehicleIds:['00000000-0000-0000-0000-000000000000']);
  const vehMap = Object.fromEntries((vehs||[]).map(v=>[v.id, v.plate]));

  adminServiceListMsg.textContent='';
  adminServiceTbl.classList.remove('hide');

  for(const r of (data||[])){
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${new Date(r.service_date).toLocaleDateString('pl-PL')}</td>
        <td><b>${vehMap[r.vehicle_id] || r.vehicle_id.slice(0,8)+'…'}</b></td>
        <td>${r.odometer_km ?? ''}</td>
        <td>${(r.description||'').replaceAll('<','&lt;')}</td>
        <td>${r.cost ?? ''}</td>
      </tr>
    `);
  }
}

init();
</script>
</body>
</html>
